{% extends 'app/seller/seller-base.html' %}
{% load static %}

{% block title %}Seller Support{% endblock %}

{% block extra_css %}
<style>
  .support-wrapper{display:flex;flex-wrap:wrap;gap:20px;margin-top:110px}
  .support-sidebar{width:260px;min-width:220px;background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.05);padding:18px;height:fit-content}
  .support-sidebar h6{font-weight:600;margin-bottom:12px}
  .support-sidebar ul{list-style:none;padding:0;margin:0}
  .support-sidebar li{padding:10px 12px;border-radius:8px;cursor:pointer;transition:.2s;font-weight:500}
  .support-sidebar li:hover,.support-sidebar li.active{background:#f1f5ff;color:#224abe}
  .support-content{flex:1;background:#fff;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.05);padding:18px;min-width:300px}
  .faq-item{border-bottom:1px solid #eee;padding:14px 0}
  .faq-item:last-child{border-bottom:0}
  .faq-item h6{cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:15px;margin:0}
  .faq-item p{display:none;margin-top:8px;color:#555;font-size:14px}
  .ticket-list{margin-top:22px}
  .ticket-table{width:100%;border-collapse:collapse;font-size:14px}
  .ticket-table th,.ticket-table td{border:1px solid #eee;padding:10px;text-align:left;vertical-align:middle}
  .ticket-table th{background:#f8f9fc;font-weight:600}
  .status-open{color:#155724;background:#d4edda;padding:3px 8px;border-radius:8px;font-size:12px;font-weight:600}
  .status-closed{color:#721c24;background:#f8d7da;padding:3px 8px;border-radius:8px;font-size:12px;font-weight:600}
  .create-ticket-btn{position:fixed;bottom:30px;right:30px;background:#4e73df;color:#fff;padding:12px 20px;border-radius:50px;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer;transition:.2s;z-index:1000}
  .create-ticket-btn:hover{background:#224abe}
  .support-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  @media(max-width:768px){.support-wrapper{flex-direction:column}.support-sidebar{width:100%}}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid support-wrapper">

  <!-- Sidebar -->
  <aside class="support-sidebar">
    <h6>Support Categories</h6>
    <ul id="supportCategories">
      <li class="active" data-category="all">All</li>
      <li data-category="general">General</li>
      <li data-category="payments">Payments</li>
      <li data-category="listings">Listings</li>
      <li data-category="technical">Technical</li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="support-content">
    <div class="support-toolbar">
      <h5 class="fw-bold mb-0">Support — <span id="currentCategoryLabel">All</span></h5>
      <div class="ms-auto d-flex" style="gap:8px;">
        <input id="supportSearch" class="form-control" type="search" placeholder="Search FAQs or tickets…">
        <button class="btn btn-outline-secondary" id="clearSearch" type="button">Clear</button>
      </div>
    </div>

    <!-- FAQs -->
    <section aria-labelledby="faqHeading">
      <h6 id="faqHeading" class="text-muted mb-2">FAQs</h6>

      <!-- GENERAL -->
      <div class="faq-item" data-category="general">
        <h6>How do I contact support?<i class="bi bi-chevron-down"></i></h6>
        <p>You can email <a href="mailto:support@propkart.com">support@propkart.com</a> or open a ticket using the button below.</p>
      </div>
      <div class="faq-item" data-category="general">
        <h6>How do I enable enquiry notifications?<i class="bi bi-chevron-down"></i></h6>
        <p>Go to Profile → Preferences and enable email / SMS alerts for new enquiries.</p>
      </div>

      <!-- PAYMENTS -->
      <div class="faq-item" data-category="payments">
        <h6>Where can I check my payment status?<i class="bi bi-chevron-down"></i></h6>
        <p>Open Analytics → Payments tab to see pending and completed settlements.</p>
      </div>
      <div class="faq-item" data-category="payments">
        <h6>What is the payout schedule?<i class="bi bi-chevron-down"></i></h6>
        <p>Payouts are processed within 2–5 business days after successful transaction confirmation.</p>
      </div>

      <!-- LISTINGS -->
      <div class="faq-item" data-category="listings">
        <h6>How do I update my property details?<i class="bi bi-chevron-down"></i></h6>
        <p>Go to My Properties → choose a property → Edit. Update details and Save/Publish.</p>
      </div>
      <div class="faq-item" data-category="listings">
        <h6>Images fail to upload — what should I do?<i class="bi bi-chevron-down"></i></h6>
        <p>Use JPG/PNG under 5MB each. If issues persist, clear cache and retry or open a ticket.</p>
      </div>

      <!-- TECHNICAL -->
      <div class="faq-item" data-category="technical">
        <h6>Dashboard is slow or not loading<i class="bi bi-chevron-down"></i></h6>
        <p>Check your network, disable ad-blockers for the site, and try an incognito window.</p>
      </div>
      <div class="faq-item" data-category="technical">
        <h6>Two-factor login not working<i class="bi bi-chevron-down"></i></h6>
        <p>Ensure device time is synced. If locked out, contact support to reset 2FA.</p>
      </div>
    </section>

    <!-- No results notice -->
    <div id="noResults" class="alert alert-light border d-none mt-3">
      No matching FAQs or tickets for this filter.
    </div>

    <!-- Ticket List -->
    <section class="ticket-list" aria-labelledby="ticketsHeading">
      <h6 id="ticketsHeading" class="text-muted mb-2">My Tickets</h6>
      <div class="table-responsive">
        <table class="ticket-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Subject</th>
              <th>Category</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="ticketBody">
            <tr data-category="payments">
              <td>#2031</td>
              <td>Payment not reflecting</td>
              <td>Payments</td>
              <td><span class="status-open">Open</span></td>
              <td>Aug 15, 2025</td>
            </tr>
            <tr data-category="listings">
              <td>#2027</td>
              <td>Unable to upload images</td>
              <td>Listings</td>
              <td><span class="status-closed">Closed</span></td>
              <td>Aug 12, 2025</td>
            </tr>
            <tr data-category="technical">
              <td>#2023</td>
              <td>Dashboard not loading</td>
              <td>Technical</td>
              <td><span class="status-open">Open</span></td>
              <td>Aug 10, 2025</td>
            </tr>
            <tr data-category="general">
              <td>#2019</td>
              <td>How to change email?</td>
              <td>General</td>
              <td><span class="status-closed">Closed</span></td>
              <td>Aug 08, 2025</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<!-- Floating Create Ticket -->
<button class="create-ticket-btn" data-bs-toggle="modal" data-bs-target="#ticketModal">
  + Create Ticket
</button>

<!-- Ticket Modal -->
<div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ticketModalLabel">Submit a Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="ticketForm" method="post" action="#">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input type="text" class="form-control" name="subject" placeholder="Enter subject" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category" id="ticketCategory" required>
              <option value="general">General</option>
              <option value="payments">Payments</option>
              <option value="listings">Listings</option>
              <option value="technical">Technical</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" rows="4" name="message" placeholder="Describe your issue" required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Submit Ticket</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const catItems = document.querySelectorAll('#supportCategories li[data-category]');
  const faqItems = document.querySelectorAll('.faq-item');
  const ticketRows = document.querySelectorAll('#ticketBody tr');
  const currentLabel = document.getElementById('currentCategoryLabel');
  const searchInput = document.getElementById('supportSearch');
  const clearBtn = document.getElementById('clearSearch');
  const noResults = document.getElementById('noResults');
  const ticketCategorySelect = document.getElementById('ticketCategory');

  // Toggle FAQ answers
  document.querySelectorAll('.faq-item h6').forEach(h => {
    h.addEventListener('click', () => {
      const body = h.nextElementSibling;
      const icon = h.querySelector('i');
      const open = body.style.display === 'block';
      body.style.display = open ? 'none' : 'block';
      icon.classList.toggle('bi-chevron-down', open);
      icon.classList.toggle('bi-chevron-up', !open);
    });
  });

  function textMatch(el, q){
    if(!q) return true;
    q = q.toLowerCase();
    const txt = el.innerText || el.textContent || '';
    return txt.toLowerCase().includes(q);
  }

  function filterContent(){
    const activeCat = document.querySelector('#supportCategories li.active')?.dataset.category || 'all';
    const q = (searchInput.value || '').trim().toLowerCase();
    let visibleCount = 0;

    // FAQs
    faqItems.forEach(item => {
      const matchCat = (activeCat === 'all') || (item.dataset.category === activeCat);
      const matchTxt = textMatch(item, q);
      const show = matchCat && matchTxt;
      item.style.display = show ? '' : 'none';
      if(show) visibleCount++;
    });

    // Tickets
    ticketRows.forEach(row => {
      const matchCat = (activeCat === 'all') || (row.dataset.category === activeCat);
      const matchTxt = textMatch(row, q);
      const show = matchCat && matchTxt;
      row.style.display = show ? '' : 'none';
      if(show) visibleCount++;
    });

    // No results message
    noResults.classList.toggle('d-none', visibleCount > 0);

    // Default selected category in modal matches current filter (if not "all")
    if (activeCat !== 'all') ticketCategorySelect.value = activeCat;
  }

  // Sidebar category click
  catItems.forEach(li => {
    li.addEventListener('click', () => {
      catItems.forEach(x => x.classList.remove('active'));
      li.classList.add('active');
      const label = li.textContent.trim();
      currentLabel.textContent = label;
      filterContent();
    });
  });

  // Live search + clear
  searchInput.addEventListener('input', filterContent);
  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    filterContent();
    searchInput.focus();
  });

  // Initialize
  filterContent();

  // Prevent form resubmission dialog on refresh (client-side)
  if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
  }
})();
</script>
{% endblock %}
