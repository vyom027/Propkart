{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="{% static 'favicon.svg' %}" />

    <meta name="description" content="Seller Dashboard - PropKart" />
    <meta name="keywords" content="dashboard, seller, properties, messages" />

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Theme CSS -->
    <link rel="stylesheet" href="{% static 'fonts/icomoon/style.css' %}" />
    <link rel="stylesheet" href="{% static 'fonts/flaticon/font/flaticon.css' %}" />
    <link rel="stylesheet" href="{% static 'css/tiny-slider.css' %}" />
    <link rel="stylesheet" href="{% static 'css/aos.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <title>{% block title %}Seller Dashboard{% endblock %} — PropKart</title>
    {% block extra_css %}{% endblock %}

    <style>
      .btn-close {
        background-color: #ef4444 !important;
        opacity: 1 !important;
        width: 24px;
        height: 24px;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <!-- Mobile Menu Container -->
    {% include 'app/seller/seller-base-mobile.html' %}
    
    <!-- Navbar -->
    <nav class="site-nav">
      <div class="container">
        <div class="menu-bg-wrap">
          <div class="site-navigation d-flex justify-content-between align-items-center">
            <a href="{% url 'seller_dashboard' %}" class="logo m-0 float-start">Seller Panel</a>
            <ul class="js-clone-nav d-none d-lg-inline-block text-start site-menu float-start">
              <li class="{% if request.resolver_match.url_name == 'index' %}active{% endif %}">
                <a href="{% url 'index' %}">Buy Property</a>
              </li>
              <li class="{% if request.resolver_match.url_name == 'seller_dashboard' %}active{% endif %}">
                <a href="{% url 'seller_dashboard' %}">Dashboard</a>
              </li>
              <li class="{% if request.resolver_match.url_name == 'my_properties' %}active{% endif %}">
                <a href="{% url 'my_properties' %}">My Properties</a>
              </li>
              <li>
                <a href="#" data-bs-toggle="modal" data-bs-target="#addPropertyModal">Add Property</a>
              </li>
              <li>
                <a href="#" data-bs-toggle="modal" data-bs-target="#uploadCsvModal">Import CSV</a>
              </li>
              <li class="{% if request.resolver_match.url_name == 'seller_messages' %}active{% endif %}">
                <a href="{% url 'seller_messages' %}">Messages</a>
              </li>
              <li class="{% if request.resolver_match.url_name == 'seller_profile' %}active{% endif %}">
                <a href="{% url 'profile' %}">Profile</a>
              </li>
               <li class="{% if request.resolver_match.url_name == 'logout' %}active{% endif %}">
                <form method="post" action="{% url 'logout' %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" style="background:none; border:none; padding:0; cursor:pointer; font-family:inherit; font-size:inherit;margin-left:20px; color:rgba(255, 255, 255, 0.5)">Log Out</button>
                    </form>
              </li>
            </ul>
            <a href="#" class="burger light ms-auto float-end site-menu-toggle js-menu-toggle d-inline-block d-lg-none">
              <span></span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <main>
      {% block content %}{% endblock %}
    </main>

    <!-- Footer Section -->
    {% include 'app/includes/footer.html' %}


    <!-- Add Property Modal -->
    <div class="modal fade" id="addPropertyModal" tabindex="-1" aria-labelledby="addPropertyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addPropertyModalLabel">Add Property</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="propertyForm" action="{% url 'property_create' %}" method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <!-- Property Details -->
              <h6 class="mb-3">Property Details</h6>
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label for="title" class="form-label">Property Title</label>
                  <input type="text" class="form-control" id="title" name="title" placeholder="e.g., Modern 3-Bedroom House" required>
                </div>
                <div class="col-md-6">
                  <label for="location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="location" name="location" placeholder="e.g., 123 Main Street, City, State" required>
                </div>
                <div class="col-md-6">
                  <label for="type" class="form-label">Property Type</label>
                  <select class="form-select" id="type" name="type" required>
                    <option value="" disabled selected>Select property type</option>
                    <option value="apartment">Apartment</option>
                    <option value="house">House</option>
                    <option value="land">Land</option>
                    <option value="villa">Villa</option>
                    <option value="commercial">Commercial</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="price" class="form-label">Price (₹)</label>
                  <input type="number" class="form-control" id="price" name="price" step="0.01" placeholder="e.g., 250000" required>
                </div>
                <div class="col-12">
                  <label for="description" class="form-label">Description</label>
                  <textarea class="form-control" id="description" name="description" rows="4" placeholder="Tell us about your property..."></textarea>
                </div>
              </div>

              <!-- Features & Amenities -->
              <h6 class="mb-3">Features & Amenities</h6>
              <div class="row g-3 mb-4">
                <div class="col-md-6">
                  <label for="length" class="form-label">Length (sq ft)</label>
                  <input type="number" class="form-control" id="length" name="length" placeholder="e.g., 500">
                </div>
                <div class="col-md-6">
                  <label for="width" class="form-label">Width (sq ft)</label>
                  <input type="number" class="form-control" id="width" name="width" placeholder="e.g., 300">
                </div>
                <div class="col-md-4 residential-field">
                  <label for="rooms" class="form-label">Total Rooms</label>
                  <input type="number" class="form-control" id="rooms" name="rooms" placeholder="e.g., 5">
                </div>
                <div class="col-md-4 residential-field">
                  <label for="bedrooms" class="form-label">Bedrooms</label>
                  <input type="number" class="form-control" id="bedrooms" name="bedrooms" placeholder="e.g., 3">
                </div>
                <div class="col-md-4 residential-field">
                  <label for="bathrooms" class="form-label">Bathrooms</label>
                  <input type="number" class="form-control" id="bathrooms" name="bathrooms" placeholder="e.g., 2">
                </div>
                <div class="col-12 residential-field">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="furnished" name="furnished">
                    <label class="form-check-label" for="furnished">This property is furnished</label>
                  </div>
                </div>
              </div>

              <!-- Property Images -->
              <h6 class="mb-3">Property Images</h6>
              <div class="mb-4">
                <label for="images" class="form-label">Upload Images</label>
                <input class="form-control" type="file" id="images" name="images" accept="image/*" multiple>
                <div id="imagePreviews" class="mt-3 d-flex flex-wrap gap-2"></div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <p id="clearAllImages" class="text-danger" style="cursor: pointer;">Clear All Images</p>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Property</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload CSV Modal -->
    <div class="modal fade" id="uploadCsvModal" tabindex="-1" aria-labelledby="uploadCsvModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadCsvModalLabel">Import Properties (CSV + Images)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="csvImportForm" method="post" action="{% url 'seller_import_properties' %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="mb-3">
                <label class="form-label">CSV File</label>
                <input type="file" name="csv_file" accept=".csv" class="form-control" required>
                <div class="form-text">CSV file containing property data</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Images ZIP File</label>
                <input type="file" name="images_zip" accept=".zip" class="form-control" required>
                <div class="form-text">ZIP file containing property images. Max 50MB. Images should be named as referenced in CSV.</div>
              </div>
              <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload & Import</button>
              </div>
            </form>
            <div class="mt-3">
              <div class="alert alert-info">
                <h6>CSV Columns (ALL REQUIRED):</h6>
                <small class="text-muted">external_id, title, description, price, location, city, state, country, type, length, width, rooms, bedrooms, bathrooms, furnished, images</small>
                <hr>
                <h6>Images Column Format:</h6>
                <small class="text-muted">Comma-separated filenames: "image1.jpg,image2.jpg,image3.jpg"</small>
                <hr>
                <h6>ZIP Structure:</h6>
                <small class="text-muted">All images should be in the root of the ZIP file. Supported formats: JPG, JPEG, PNG, WEBP</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/tiny-slider.js' %}"></script>
    <script src="{% static 'js/aos.js' %}"></script>
    <script src="{% static 'js/custom.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    {% block extra_js %}{% endblock %}

    <!-- Custom Script -->
    <script>
      // Toggle residential fields based on property type
      const propertyTypeSelect = document.getElementById('type');
      const residentialFields = document.querySelectorAll('.residential-field');
      const toggleFields = () => {
        const selectedType = propertyTypeSelect.value;
        const showResidential = ['apartment', 'house', 'villa'].includes(selectedType);
        residentialFields.forEach(field => {
          field.style.display = showResidential ? 'block' : 'none';
        });
      };
      propertyTypeSelect.addEventListener('change', toggleFields);
      document.addEventListener('DOMContentLoaded', toggleFields);
    </script>
<script>
  const imagesInput = document.getElementById('images');
  const imagePreviews = document.getElementById('imagePreviews');
  const clearAllImages = document.getElementById('clearAllImages');
  const propertyForm = document.getElementById('propertyForm');
  let selectedFiles = [];

  // Handle file selection
  imagesInput.addEventListener('change', function () {
    selectedFiles = selectedFiles.concat(Array.from(this.files));
    updatePreviews();
    this.value = null; // reset input so same file can be added again if needed
  });

  // Clear all images
  clearAllImages.addEventListener('click', function () {
    if (selectedFiles.length === 0) return;
    if (confirm("Are you sure you want to remove all images?")) {
      selectedFiles = [];
      updatePreviews();
    }
  });

  // Update image previews
  function updatePreviews() {
    imagePreviews.innerHTML = '';
    if (selectedFiles.length === 0) {
      imagePreviews.innerHTML = '<p class="text-muted">No images selected</p>';
      return;
    }
    selectedFiles.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (e) {
        const div = document.createElement('div');
        div.classList.add('position-relative');
        div.style.width = '100px';
        div.style.height = '100px';
        div.innerHTML = `
          <img src="${e.target.result}" class="img-thumbnail" alt="Preview">
          <button type="button" class="btn-close position-absolute top-0 end-0 bg-danger text-white" aria-label="Remove" onclick="removeImage(${index})"></button>
        `;
        imagePreviews.appendChild(div);
      };
      reader.readAsDataURL(file);
    });
  }

  // Remove a single image
  function removeImage(index) {
    selectedFiles.splice(index, 1);
    updatePreviews();
  }

  // Handle form submission with image files
  propertyForm.addEventListener('submit', function (e) {
    e.preventDefault();

    if (selectedFiles.length === 0) {
      alert("Please select at least one image.");
      return;
    }

    const formData = new FormData(propertyForm);

    // Append each selected file to the form data
    selectedFiles.forEach(file => {
      formData.append('images', file);
    });

    fetch(propertyForm.action, {
      method: propertyForm.method,
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => {
      if (response.ok) {
        alert('Property added successfully!');
        window.location.reload();
      } else {
        return response.text().then(text => { throw new Error(text); });
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('There was an error submitting the form.');
    });
  });
</script>



  </body>
</html>
