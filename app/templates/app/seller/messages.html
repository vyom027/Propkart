{% extends 'app/seller/seller-base.html' %}
{% load static %}

{% block title %}Messages{% endblock %}

{% block content %}
<div class="container py-5" style="min-height:70vh;">
  <h2 class="fw-bold mb-4">Messages</h2>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="bg-white rounded shadow-sm" style="overflow:hidden;">
        <div class="p-3 border-bottom bg-light fw-semibold">Conversations</div>
        <div>
          {% if threads %}
            {% for t in threads %}
            {% with last=t.last unread=t.unread_count %}
            <a href="?property={{ last.property_id }}&buyer={{ last.sender_id }}" class="d-block text-decoration-none text-reset">
              <div class="p-3 border-bottom {% if unread > 0 %}bg-warning-subtle{% endif %}">
                <div class="fw-semibold">
                  {{ last.sender.first_name }} {{ last.sender.last_name }}
                  {% if "ENQUIRY:" in last.content %}
                    <i class="bi bi-envelope-fill text-info ms-1" title="Contains Enquiry"></i>
                  {% endif %}
                </div>
                <div class="text-muted small">{{ last.property.title }}</div>
                <div class="small text-muted">{{ last.sent_at|date:'M d, Y H:i' }}</div>
                {% if unread > 0 %}<span class="badge bg-danger mt-1">{{ unread }}</span>{% endif %}
        </div>
            </a>
            {% endwith %}
            {% endfor %}
          {% else %}
            <div class="p-4 text-muted">No conversations yet.</div>
          {% endif %}
            </div>
          </div>
        </div>
    <div class="col-lg-8">
      <div class="bg-white rounded shadow-sm d-flex flex-column" style="min-height:500px;">
        <div class="p-3 border-bottom bg-light fw-semibold d-flex justify-content-between align-items-center">Conversation
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-danger" id="sellerDeleteSelected" disabled>Delete Selected</button>
            <button class="btn btn-sm btn-outline-secondary" id="sellerClearChat" {% if not selected_property_id %}disabled{% endif %}>Clear Chat</button>
            </div>
          </div>
        <div id="chatBody" class="p-3 flex-grow-1" style="background:#f8f9fa; overflow-y:auto; max-height:65vh; scrollbar-width: thin;">
          {% if related_enquiries %}
            <!-- Show related enquiries at the top -->
            <div class="mb-3">
              {% for enquiry in related_enquiries %}
                <div class="alert alert-info border-start border-info border-4 mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="alert-heading mb-1">
                        <i class="bi bi-envelope-fill me-2"></i>Enquiry from {{ enquiry.buyer_name }}
                      </h6>
                      <p class="mb-1">{{ enquiry.message }}</p>
                      <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>{{ enquiry.created_at|date:"M d, Y g:i A" }} | 
                        <i class="bi bi-envelope me-1"></i>{{ enquiry.buyer_email }} | 
                        <i class="bi bi-telephone me-1"></i>{{ enquiry.buyer_phone }}
                      </small>
                    </div>
                    <span class="badge bg-{% if enquiry.status == 'new' %}warning{% elif enquiry.status == 'replied' %}success{% else %}secondary{% endif %}">
                      {{ enquiry.status|title }}
                    </span>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
          
          {% if conversation %}
            {% for m in conversation %}
              <div class="d-flex align-items-start mb-2 {% if m.sender_id == user.id %}justify-content-end{% else %}justify-content-start{% endif %}" data-id="{{ m.id }}">
                {% if m.sender_id == user.id %}
                <input type="checkbox" class="form-check-input me-2 seller-msg-check" value="{{ m.id }}">
                {% else %}
                <span class="me-2" style="width:1.25rem;"></span>
                {% endif %}
                <div class="p-2 rounded {% if m.sender_id == user.id %}bg-primary text-white{% else %}bg-white border{% endif %}" style="max-width:70%;">
                  <div>{{ m.content }}</div>
                  <div class="small opacity-75 mt-1">{{ m.sent_at|date:'M d, Y H:i' }}</div>
            </div>
          </div>
            {% endfor %}
          {% else %}
            <div class="text-muted">Select a conversation to view messages.</div>
          {% endif %}
        </div>
        <div class="p-3 border-top bg-white">
          <form id="replyForm" method="post" action="{% url 'message_reply' %}" onsubmit="return false">
            {% csrf_token %}
            <input type="hidden" name="property_id" id="propertyIdInput" value="{{ selected_property_id|default:'' }}">
            <input type="hidden" name="recipient_id" id="recipientIdInput" value="{{ selected_buyer_id|default:'' }}">
            <div class="d-flex gap-2">
              <input type="text" id="messageInput" name="message" class="form-control" placeholder="Type a reply..." {% if not conversation %}disabled{% endif %}>
              <button class="btn btn-primary" type="button" id="sellerSendBtn" {% if not conversation %}disabled{% endif %}>Send</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const form = document.getElementById('replyForm');
  const chat = document.getElementById('chatBody');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sellerSendBtn');
  const propId = document.getElementById('propertyIdInput')?.value;
  const peerId = document.getElementById('recipientIdInput')?.value;
  let lastTs = null;

  if (chat) {
    setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 0);
  }

  if (sendBtn && form) {
    const doSend = async () => {
      const text = (input.value || '').trim();
      if (!text) return;
      try {
        function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
        const CSRF = getCookie('csrftoken');
        const resp = await fetch(form.action, { method: 'POST', headers: { 'X-CSRFToken': CSRF }, body: new FormData(form) });
        const data = await resp.json();
        if (!data.success) { alert(data.error || 'Failed'); return; }
        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex align-items-start mb-2 justify-content-end';
        wrapper.setAttribute('data-id', data.id);
        wrapper.innerHTML = '<input type="checkbox" class="form-check-input me-2 seller-msg-check" value="' + data.id + '">'
          + '<div class="p-2 rounded bg-primary text-white" style="max-width:70%;"><div>'
          + text.replace(/</g,'&lt;') + '</div><div class="small opacity-75 mt-1">' + data.timestamp + '</div></div>';
        chat.appendChild(wrapper);
        chat.scrollTop = chat.scrollHeight;
        input.value = '';
        lastTs = new Date().toISOString();
        if (deleteBtn) deleteBtn.disabled = false;
      } catch(err) { alert('Failed to send message'); }
    };

    sendBtn.addEventListener('click', doSend);
    input.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
    });
  }

  async function poll() {
    if (!propId || !peerId) return;
    const params = new URLSearchParams({ property: propId, peer: peerId });
    try {
      const resp = await fetch(`{% url 'chat_conversation' %}?` + params.toString());
      const data = await resp.json();
      if (data && Array.isArray(data.messages)) {
        const frag = document.createDocumentFragment();
        if (data.messages.length === 0) {
          chat.innerHTML = '<div class="text-muted">No messages in this conversation.</div>';
        } else {
          chat.innerHTML = '';
          for (const m of data.messages) {
            const mine = (m.sender_id == {{ user.id }});
            const wrapper = document.createElement('div');
            wrapper.className = 'd-flex align-items-start mb-2 ' + (mine ? 'justify-content-end' : 'justify-content-start');
            wrapper.setAttribute('data-id', m.id);
            const leading = mine ? '<input type="checkbox" class="form-check-input me-2 seller-msg-check" value="' + m.id + '">' : '<span class="me-2" style="width:1.25rem;"></span>';
            wrapper.innerHTML = leading + '<div class="p-2 rounded ' + (mine ? 'bg-primary text-white' : 'bg-white border') + '" style="max-width:70%;"><div>'
              + m.content.replace(/</g,'&lt;') + '</div><div class="small opacity-75 mt-1">' + new Date(m.sent_at).toLocaleString() + '</div></div>';
            frag.appendChild(wrapper);
          }
          chat.appendChild(frag);
        }
        chat.scrollTop = chat.scrollHeight;
        checksChange();
      }
    } catch(e) { /* ignore */ }
  }

  (function initTs(){
    const msgs = chat.querySelectorAll('.small.opacity-75');
    if (msgs.length) chat.scrollTop = chat.scrollHeight;
  })();

  setInterval(poll, 3000);

  const deleteBtn = document.getElementById('sellerDeleteSelected');
  const clearBtn = document.getElementById('sellerClearChat');
  const checksChange = () => {
    const any = chat.querySelectorAll('.seller-msg-check:checked').length > 0;
    if (deleteBtn) deleteBtn.disabled = !any;
  };
  chat.addEventListener('change', (e)=>{ if (e.target.classList.contains('seller-msg-check')) checksChange(); });
  checksChange();

  if (deleteBtn) {
    deleteBtn.addEventListener('click', async function(){
      const ids = Array.from(chat.querySelectorAll('.seller-msg-check:checked')).map(el=>el.value).join(',');
      if (!ids) return;
      try {
        function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
        const CSRF = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('property_id', propId);
        formData.append('peer_id', peerId);
        formData.append('ids', ids);
        const resp = await fetch('{% url 'chat_delete_messages' %}', { method: 'POST', headers: { 'X-CSRFToken': CSRF }, body: formData });
        const data = await resp.json();
        if (!data.success) { alert(data.error || 'Failed'); return; }
        chat.querySelectorAll('.seller-msg-check:checked').forEach(el => el.closest('[data-id]')?.remove());
        if (!chat.querySelector('[data-id]')) chat.innerHTML = '<div class="text-muted">No messages in this conversation.</div>';
        lastTs = new Date().toISOString();
        checksChange();
      } catch(err) { alert('Failed to delete'); }
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', async function(){
      if (!confirm('Clear entire conversation?')) return;
      try {
        function getCookie(name){ const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return m?m.pop():''; }
        const CSRF = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('property_id', propId);
        formData.append('peer_id', peerId);
        const resp = await fetch('{% url 'chat_clear_conversation' %}', { method: 'POST', headers: { 'X-CSRFToken': CSRF }, body: formData });
        const data = await resp.json();
        if (!data.success) { alert(data.error || 'Failed'); return; }
        chat.innerHTML = '<div class="text-muted">No messages in this conversation.</div>';
        if (deleteBtn) deleteBtn.disabled = true;
        lastTs = new Date().toISOString();
      } catch(err) { alert('Failed to clear'); }
    });
  }

})();
</script>
{% endblock %}
