{% extends 'app/seller/seller-base.html' %}
{% load static %}

{% block title %}Analytics{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .analytics-card {
    height: 280px; /* keeps cards uniform */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .chart-container {
    position: relative;
    height: 200px; /* fix height */
    width: 100%;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4" style="margin-top: 110px;">

  <!-- Page Title -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Seller Analytics Dashboard</h2>
    <span class="text-muted">Performance overview of your listings</span>
  </div>

  <!-- Stats Overview -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="fw-semibold text-muted">Total Properties</h6>
        <h2 class="text-primary fw-bold">{{ total_properties }}</h2>
        <small class="text-success">{{ new_properties }} new this month</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="fw-semibold text-muted">Total Views</h6>
        <h2 class="text-success fw-bold">{{ total_views }}</h2>
        <small class="text-success">{{ views_growth }}% growth</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="fw-semibold text-muted">Visit Requests</h6>
        <h2 class="text-warning fw-bold">{{ visit_requests }}</h2>
        <small class="{% if visit_requests_growth >= 0 %}text-success{% else %}text-danger{% endif %}">{{ visit_requests_growth }}% this week</small>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="card shadow-sm border-0 text-center p-3">
        <h6 class="fw-semibold text-muted">Enquiries</h6>
        <h2 class="text-danger fw-bold">{{ total_enquiries }}</h2>
        <small class="text-success">{{ new_enquiries }} new enquiries</small>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 analytics-card">
        <div class="card-body">
          <h6 class="card-title fw-semibold">Enquiries Trend</h6>
          <div class="chart-container">
            <canvas id="enquiriesChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm border-0 analytics-card">
        <div class="card-body">
          <h6 class="card-title fw-semibold">Property Distribution</h6>
          <div class="chart-container">
            <canvas id="propertyChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Visitors -->
  <div class="row g-4 mt-1">
    <div class="col-12">
      <div class="card shadow-sm border-0 analytics-card">
        <div class="card-body">
          <h6 class="card-title fw-semibold">Visitor Insights</h6>
          <div class="chart-container">
            <canvas id="visitorsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Charts Script -->
<script>
  // Enquiries Trend
  new Chart(document.getElementById('enquiriesChart'), {
    type: 'line',
    data: {
      labels: {{ enquiry_months|safe }},
      datasets: [{
        label: 'New',
        data: {{ enquiry_data.new }},
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      },
      {
        label: 'Replied',
        data: {{ enquiry_data.replied }},
        borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      },
      {
        label: 'Closed',
        data: {{ enquiry_data.closed }},
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.2)',
        borderWidth: 2,
        fill: true,
        tension: 0.3
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true,
          position: 'top'
        }
      }
    }
  });

  // Property Distribution
  new Chart(document.getElementById('propertyChart'), {
    type: 'doughnut',
    data: {
      labels: {{ property_types|safe }},
      datasets: [{
        data: {{ property_counts }},
        backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6610f2']
      }]
    },
    options: { 
      responsive: true, 
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          position: 'bottom',
          labels: {
            padding: 20
          }
        }
      }
    }
  });

  // Visit Request Status
  new Chart(document.getElementById('visitorsChart'), {
    type: 'bar',
    data: {
      labels: {{ visit_months|safe }},
      datasets: [{
        label: 'Pending',
        data: {{ visit_data.pending }},
        backgroundColor: '#ffc107'
      },
      {
        label: 'Approved',
        data: {{ visit_data.approved }},
        backgroundColor: '#198754'
      },
      {
        label: 'Completed',
        data: {{ visit_data.completed }},
        backgroundColor: '#0d6efd'
      },
      {
        label: 'Cancelled',
        data: {{ visit_data.cancelled }},
        backgroundColor: '#dc3545'
      }]
    },
    options: { 
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true,
          position: 'top'
        }
      },
      scales: { 
        x: { stacked: true },
        y: { 
          stacked: true,
          beginAtZero: true 
        }
      }
    }
  });
</script>
{% endblock %}
