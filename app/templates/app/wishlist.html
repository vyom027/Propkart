{% extends 'app/base.html' %}
{% load static %}

{% block title %}My Wishlist{% endblock %}

{% block content %}
<div class="section section-properties bg-light">
  <div class="container">
    <style>
      .properties-grid-enhanced { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
      .property-card-enhanced { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.08); }
      .property-card-inner { display: flex; flex-direction: column; height: 100%; }
      .property-image-container { position: relative; height: 200px; overflow: hidden; }
      .property-image { width: 100%; height: 100%; object-fit: cover; }
      .property-badges { position: absolute; top: 12px; left: 12px; right: 12px; display: flex; justify-content: space-between; }
      .property-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 8px; }
      .property-actions .btn { width: 32px; height: 32px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
      .property-content-enhanced { padding: 1rem; display: flex; flex-direction: column; gap: .5rem; flex: 1; }
      .property-specs { display: flex; gap: 1rem; flex-wrap: wrap; color: #6c757d; font-size: .9rem; }
      .property-footer { margin-top: auto; display: flex; align-items: center; justify-content: space-between; }
      @media (max-width: 576px) { .property-image-container { height: 180px; } }
    </style>
    <!-- Header card -->
    <div class="row mb-4" style="margin-top: 50px;">
      <div class="col-12">
        <div class="properties-header-card d-flex align-items-center justify-content-between">
          <div>
            <h3 class="mb-1">My Wishlist</h3>
            <p class="text-muted mb-0">Saved properties you love ({{ items|length }})</p>
          </div>
          <div>
            <a href="{% url 'property_list' %}" class="btn btn-outline-primary btn-sm">Back to Properties</a>
          </div>
        </div>
      </div>
    </div>

    {% if items %}
    <div class="properties-grid-enhanced">
      {% for w in items %}
      {% with p=w.property %}
      <div class="property-card-enhanced">
        <div class="property-card-inner">
          <div class="property-image-container">
            <img src="{% if p.images.all %}{{ p.images.all.0.image.url }}{% else %}{% static 'images/no-image.png' %}{% endif %}"
                 alt="{{ p.title }}" class="property-image">

            <div class="property-badges">
              <span class="badge bg-primary">{{ p.get_type_display }}</span>
              <span class="badge bg-success">₹{{ p.price|floatformat:0 }}</span>
            </div>

            <div class="property-actions">
              <button class="btn btn-sm btn-light rounded-circle me-2 wishlist-remove-btn" data-property-id="{{ p.id }}" title="Remove from Wishlist">
                <i class="bi bi-heartbreak"></i>
              </button>
              <a class="btn btn-sm btn-light rounded-circle" href="/property/{{ p.id }}/" title="Open">
                <i class="bi bi-box-arrow-up-right"></i>
              </a>
            </div>
          </div>

          <div class="property-content-enhanced">
            <h5 class="property-title">{{ p.title }}</h5>
            <p class="property-location"><i class="bi bi-geo-alt me-1"></i>{{ p.city }}, {{ p.state }}</p>

            <div class="property-specs">
              {% if p.bedrooms %}<div class="spec-item"><i class="bi bi-bed me-1"></i>{{ p.bedrooms }} beds</div>{% endif %}
              {% if p.bathrooms %}<div class="spec-item"><i class="bi bi-droplet me-1"></i>{{ p.bathrooms }} baths</div>{% endif %}
              <div class="spec-item"><i class="bi bi-eye me-1"></i>{{ p.views }} views</div>
            </div>

            <div class="property-footer">
              <div class="property-price-display">
                <span class="price-amount">₹{{ p.price|floatformat:0 }}</span>
                <span class="price-label">total</span>
              </div>
              <a href="/property/{{ p.id }}/" class="btn btn-primary btn-sm">View Details</a>
            </div>
          </div>
        </div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-heart text-muted" style="font-size: 3rem;"></i>
        <h5 class="text-muted mt-3">Your wishlist is empty</h5>
        <a href="{% url 'property_list' %}" class="btn btn-primary mt-2">Browse Properties</a>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.wishlist-remove-btn').forEach(btn => {
      btn.addEventListener('click', async function(e){
        e.preventDefault();
        const card = this.closest('.property-card-enhanced');
        const propertyId = this.getAttribute('data-property-id');
        try {
          const resp = await fetch('{% url "wishlist_toggle" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': (document.cookie.split(';').find(c=>c.trim().startsWith('csrftoken='))||'').split('=')[1] || ''
            },
            body: JSON.stringify({ property_id: propertyId })
          });
          const data = await resp.json();
          if (data.success && !data.saved && card) {
            card.remove();
          }
        } catch(err) {
          console.error(err);
        }
      });
    });
  });
</script>
{% endblock %}


